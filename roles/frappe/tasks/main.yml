---
- name: Download NodeSource Setup Script
  get_url:
    url: "https://deb.nodesource.com/setup_{{ node_version }}"
    dest: /tmp/nodesource_setup.sh
    mode: '0755'

- name: Run NodeSource Setup Script
  command: /tmp/nodesource_setup.sh
  args:
    creates: /etc/apt/sources.list.d/nodesource.list

- name: Install Node.js
  apt:
    name: nodejs
    state: present
    update_cache: yes

- name: Install Yarn
  npm:
    name: yarn
    global: yes

- name: Install Frappe Bench CLI
  pip:
    name: frappe-bench
    executable: pip3
    extra_args: --break-system-packages

- name: Initialize Bench (Can take time)
  become_user: "{{ frappe_user }}"
  command: "bench init --frappe-branch {{ frappe_branch }} {{ bench_name }}"
  args:
    chdir: "/home/{{ frappe_user }}"
    creates: "/home/{{ frappe_user }}/{{ bench_name }}"

- name: Enable Developer Mode
  become_user: "{{ frappe_user }}"
  command: "bench set-config -g developer_mode 1"
  args:
    chdir: "/home/{{ frappe_user }}/{{ bench_name }}"

# --- SSH SETUP FOR PRIVATE REPOS ---

- name: Generate SSH Key for Frappe User
  user:
    name: "{{ frappe_user }}"
    generate_ssh_key: yes
    ssh_key_bits: 2048
    ssh_key_file: .ssh/id_rsa

- name: Read SSH Public Key
  shell: cat /home/{{ frappe_user }}/.ssh/id_rsa.pub
  register: ssh_pub_key
  changed_when: false

- name: Display SSH Key (Add this to GitHub/GitLab Deploy Keys)
  debug:
    msg: 
      - "-----------------------------------------------------------"
      - "{{ ssh_pub_key.stdout }}"
      - "-----------------------------------------------------------"

- name: Pause for Manual Step
  pause:
    prompt: "Copy the key above, add it to your Repo's Deploy Keys (Settings > Deploy Keys), then press Enter to continue..."

- name: Add GitHub to known_hosts (Prevents 'Yes/No' hang)
  become_user: "{{ frappe_user }}"
  shell: "ssh-keyscan github.com >> ~/.ssh/known_hosts"
  args:
    chdir: "/home/{{ frappe_user }}"
  ignore_errors: yes

# --- APP DOWNLOADS ---

- name: Get Public Apps (Payments, ERPNext, HRMS, India Compliance)
  become_user: "{{ frappe_user }}"
  shell: |
    bench get-app payments &&
    bench get-app --branch {{ frappe_branch }} erpnext &&
    bench get-app --branch {{ frappe_branch }} hrms &&
    bench get-app --branch {{ frappe_branch }} india_compliance
  args:
    chdir: "/home/{{ frappe_user }}/{{ bench_name }}"
    creates: "/home/{{ frappe_user }}/{{ bench_name }}/apps/erpnext"

- name: Get Private App (Raplbaddi)
  become_user: "{{ frappe_user }}"
  # Using 'creates' ensures we don't fail if it's already cloned
  command: "bench get-app --branch develop git@github.com:bhickta/raplbaddi.git"
  args:
    chdir: "/home/{{ frappe_user }}/{{ bench_name }}"
    creates: "/home/{{ frappe_user }}/{{ bench_name }}/apps/raplbaddi"

# --- SITE CREATION ---

- name: Create New Site
  become_user: "{{ frappe_user }}"
  command: >
    bench new-site {{ site_name }}
    --admin-password {{ admin_password }}
    --db-root-password {{ db_root_password }}
    --install-app erpnext
  args:
    chdir: "/home/{{ frappe_user }}/{{ bench_name }}"
    creates: "/home/{{ frappe_user }}/{{ bench_name }}/sites/{{ site_name }}"

# --- APP INSTALLATION (Requires Temp Redis) ---

- name: Start Temporary Redis (For Installation)
  become_user: "{{ frappe_user }}"
  shell: "/usr/bin/redis-server --port 13000 --daemonize yes"
  ignore_errors: yes

- name: Install Apps on Site (HRMS, India Compliance, Raplbaddi)
  become_user: "{{ frappe_user }}"
  shell: |
    bench --site {{ site_name }} install-app hrms &&
    bench --site {{ site_name }} install-app india_compliance &&
    bench --site {{ site_name }} install-app raplbaddi
  args:
    chdir: "/home/{{ frappe_user }}/{{ bench_name }}"
  ignore_errors: yes

- name: Kill Temporary Redis
  shell: "pkill redis-server"
  ignore_errors: yes